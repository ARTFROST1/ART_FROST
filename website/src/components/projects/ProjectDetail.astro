---
/**
 * ProjectDetail Component
 * Full project information display with gallery, details and technologies
 * Used on individual project pages (/projects/[slug])
 * 
 * Features:
 * - Symmetric two-column layout
 * - Fullscreen image gallery with lightbox
 * - Technologies section under gallery (left column)
 * - Project info and meta on right
 * - Minimalist, stylish design
 * 
 * @example
 * <ProjectDetail project={project} />
 */

import { cn } from '@lib/utils';
import Container from '@components/common/Container.astro';
import Button from '@components/common/Button.astro';
import Icon from '@components/common/Icon.astro';
import ImageLightbox from './ImageLightbox.tsx';
import type { CollectionEntry } from 'astro:content';

interface Props {
  /** Project data from Content Collection */
  project: CollectionEntry<'projects'>;
  /** Additional CSS classes */
  class?: string;
}

const { project, class: className } = Astro.props;
const { data } = project;

// Status configuration
const statusConfig = {
  completed: {
    label: 'Завершён',
    classes: 'bg-brand-500/10 border-brand-500/30 text-brand-500',
  },
  'in-progress': {
    label: 'В разработке',
    classes: 'bg-amber-500/10 border-amber-500/30 text-amber-400',
  },
  planned: {
    label: 'Планируется',
    classes: 'bg-sky-500/10 border-sky-500/30 text-sky-400',
  },
  archived: {
    label: 'Архив',
    classes: 'bg-zinc-500/10 border-zinc-500/30 text-zinc-400',
  },
} as const;

// Type labels
const typeLabels = {
  website: 'Веб-сайт',
  app: 'Приложение',
  library: 'Библиотека',
  tool: 'Инструмент',
  template: 'Шаблон',
  other: 'Проект',
} as const;

// Format date
const formatDate = (dateStr?: string) => {
  if (!dateStr) return null;
  const date = new Date(dateStr);
  return date.toLocaleDateString('ru-RU', {
    year: 'numeric',
    month: 'long',
  });
};

const currentStatus = statusConfig[data.status || 'completed'];
const projectType = typeLabels[data.type || 'other'];
const startDate = formatDate(data.date);
const completedDate = formatDate(data.completedDate);

// Combine main image with gallery images
const allImages = [
  ...(data.image ? [data.image] : []),
  ...(data.images || []),
];

// Prepare meta items
const metaItems = [
  startDate && { icon: 'calendar', label: 'Запуск', value: startDate },
  data.role && { icon: 'user', label: 'Роль', value: data.role },
  data.teamSize && { icon: 'users', label: 'Команда', value: `${data.teamSize} чел.` },
  completedDate && data.status === 'completed' && { icon: 'check-circle', label: 'Завершён', value: completedDate, accent: true },
].filter(Boolean) as { icon: string; label: string; value: string; accent?: boolean }[];
---

<article class={cn('relative', className)}>
  <!-- Back Navigation -->
  <section class="relative pt-8 pb-4">
    <Container>
      <a
        href="/projects"
        class={cn(
          'inline-flex items-center gap-2',
          'text-sm font-medium text-[var(--color-text-muted)]',
          'hover:text-[var(--color-primary)] transition-colors duration-200'
        )}
      >
        <Icon name="arrow-left" size="sm" />
        <span>Все проекты</span>
      </a>
    </Container>
  </section>

  <!-- Main Content -->
  <section class="relative py-8 md:py-12 overflow-hidden">
    {/* Background ambient glows */}
    <div class="absolute inset-0 pointer-events-none" aria-hidden="true">
      <div
        class="absolute top-20 right-0 w-[500px] h-[500px]"
        style="background: radial-gradient(circle at 70% 30%, rgba(52,184,99,0.10) 0%, transparent 60%);"
      />
      <div
        class="absolute bottom-0 left-0 w-[400px] h-[400px]"
        style="background: radial-gradient(circle at 20% 80%, rgba(52,184,99,0.06) 0%, transparent 60%);"
      />
    </div>

    <Container>
      <div class="relative z-10 grid grid-cols-1 lg:grid-cols-12 gap-8 lg:gap-12">
        
        <!-- LEFT COLUMN: Gallery + Technologies -->
        <div class="lg:col-span-7 space-y-8">
          
          <!-- Gallery with Lightbox -->
          {allImages.length > 0 ? (
            <ImageLightbox 
              images={allImages} 
              projectTitle={data.title}
              client:load
            />
          ) : (
            <div class={cn(
              'relative aspect-[16/10] rounded-2xl overflow-hidden',
              'bg-gradient-to-br from-[var(--color-bg-secondary)] to-[var(--color-bg-primary)]',
              'border border-[var(--color-border-glass)]'
            )}>
              <div
                class="absolute inset-0 opacity-20"
                style="background-image: radial-gradient(circle at 2px 2px, var(--color-border-glass) 1px, transparent 1px); background-size: 32px 32px;"
              />
              <div class="absolute inset-0 flex items-center justify-center">
                <div class={cn(
                  'p-6 rounded-2xl',
                  'bg-[var(--color-bg-glass)] backdrop-blur-sm',
                  'border border-[var(--color-border-glass)]'
                )}>
                  <Icon name="image" size="xl" class="text-[var(--color-text-muted)]" />
                </div>
              </div>
            </div>
          )}

          <!-- Technologies (Under Gallery for Symmetry) -->
          {data.tags && data.tags.length > 0 && (
            <div class="mt-6 space-y-4">
              <div class="flex items-center gap-3">
                <div class={cn(
                  'w-8 h-8 rounded-lg',
                  'bg-[var(--color-primary)]/10',
                  'flex items-center justify-center',
                  'text-[var(--color-primary)]'
                )}>
                  <Icon name="code" size="sm" />
                </div>
                <h3 class="text-sm font-semibold uppercase tracking-wider text-[var(--color-text-muted)]">
                  Технологии
                </h3>
              </div>
              
              <div class="flex flex-wrap gap-2">
                {data.tags.map((tag: string) => (
                  <span class={cn(
                    'px-3 py-1.5 rounded-lg',
                    'text-sm font-medium',
                    'bg-[var(--color-bg-glass)]',
                    'border border-[var(--color-border-glass)]',
                    'text-[var(--color-text-body)]',
                    'hover:border-[var(--color-primary)]/30',
                    'hover:text-[var(--color-primary)]',
                    'transition-all duration-200'
                  )}>
                    {tag}
                  </span>
                ))}
              </div>
            </div>
          )}
        </div>

        <!-- RIGHT COLUMN: Project Info -->
        <div class="lg:col-span-5 space-y-6">
          
          <!-- Status & Type Badges -->
          <div class="flex flex-wrap items-center gap-2">
            <span class={cn(
              'inline-flex items-center px-3 py-1',
              'text-xs font-semibold uppercase tracking-wider rounded-full',
              'border',
              currentStatus.classes
            )}>
              {currentStatus.label}
            </span>
            <span class={cn(
              'inline-flex items-center px-3 py-1',
              'text-xs font-medium rounded-full',
              'bg-[var(--color-bg-glass)]',
              'border border-[var(--color-border-glass)]',
              'text-[var(--color-text-muted)]'
            )}>
              {projectType}
            </span>
            {data.featured && (
              <span class={cn(
                'inline-flex items-center gap-1 px-3 py-1',
                'text-xs font-medium rounded-full',
                'bg-[var(--color-primary)]/10',
                'border border-[var(--color-primary)]/30',
                'text-[var(--color-primary)]'
              )}>
                <svg class="w-3 h-3" viewBox="0 0 24 24" fill="currentColor">
                  <path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z" />
                </svg>
                Featured
              </span>
            )}
          </div>

          <!-- Title -->
          <h1 class="text-3xl md:text-4xl lg:text-5xl font-bold text-[var(--color-text-heading)] leading-tight tracking-tight">
            {data.title}
          </h1>

          <!-- Description -->
          <p class="text-base md:text-lg text-[var(--color-text-body)] leading-relaxed">
            {data.description}
          </p>

          <!-- Action Buttons -->
          <div class="flex flex-wrap gap-3 pt-2">
            {data.demo && (
              <Button
                href={data.demo}
                variant="primary"
                size="md"
                external
              >
                <Icon name="external-link" size="sm" />
                Открыть проект
              </Button>
            )}
            {data.github && (
              <Button
                href={data.github}
                variant="outline"
                size="md"
                external
              >
                <Icon name="github" size="sm" />
                GitHub
              </Button>
            )}
            {data.links && data.links.map((link) => (
              <Button
                href={link.url}
                variant="ghost"
                size="md"
                external
              >
                {link.icon && <Icon name={link.icon} size="sm" />}
                {link.label}
              </Button>
            ))}
          </div>

          <!-- Meta Info Card -->
          {metaItems.length > 0 && (
            <div class={cn(
              'p-5 rounded-2xl mt-4',
              'bg-[var(--color-bg-glass)]',
              'border border-[var(--color-border-glass)]'
            )}>
              <div class={cn(
                'grid gap-4',
                metaItems.length === 1 && 'grid-cols-1',
                metaItems.length === 2 && 'grid-cols-2',
                metaItems.length === 3 && 'grid-cols-3',
                metaItems.length >= 4 && 'grid-cols-2'
              )}>
                {metaItems.map((item) => (
                  <div class="flex items-center gap-3">
                    <div class={cn(
                      'w-9 h-9 rounded-xl flex items-center justify-center',
                      item.accent 
                        ? 'bg-brand-500/10 text-brand-500'
                        : 'bg-[var(--color-primary)]/10 text-[var(--color-primary)]'
                    )}>
                      <Icon name={item.icon} size="sm" />
                    </div>
                    <div class="min-w-0">
                      <p class="text-[10px] uppercase tracking-wider text-[var(--color-text-muted)]">
                        {item.label}
                      </p>
                      <p class={cn(
                        'text-sm font-semibold truncate',
                        item.accent ? 'text-brand-500' : 'text-[var(--color-text-heading)]'
                      )}>
                        {item.value}
                      </p>
                    </div>
                  </div>
                ))}
              </div>
            </div>
          )}
        </div>
      </div>
    </Container>
  </section>

  <!-- Highlights Section -->
  {data.highlights && data.highlights.length > 0 && (
    <section class="py-16 md:py-20 border-t border-[var(--color-border-glass)]">
      <Container>
        <div class="max-w-4xl mx-auto">
          <!-- Section Header -->
          <div class="text-center mb-12">
            <div class={cn(
              'inline-flex items-center gap-2 px-3 py-1.5 mb-4',
              'text-xs font-semibold uppercase tracking-wider rounded-full',
              'bg-[var(--color-primary)]/10',
              'border border-[var(--color-primary)]/20',
              'text-[var(--color-primary)]'
            )}>
              <Icon name="star" size="sm" />
              Результаты
            </div>
            <h2 class="text-2xl md:text-3xl font-bold text-[var(--color-text-heading)]">
              Ключевые достижения
            </h2>
          </div>

          <!-- Highlights Grid -->
          <div class={cn(
            'grid gap-4',
            data.highlights.length <= 2 && 'grid-cols-1 md:grid-cols-2',
            data.highlights.length === 3 && 'grid-cols-1 md:grid-cols-3',
            data.highlights.length >= 4 && 'grid-cols-1 md:grid-cols-2'
          )}>
            {data.highlights.map((highlight: string, index: number) => (
              <div class={cn(
                'group relative p-5 rounded-2xl',
                'bg-[var(--color-bg-glass)]',
                'border border-[var(--color-border-glass)]',
                'hover:border-[var(--color-primary)]/30',
                'transition-all duration-300'
              )}>
                <div class="flex items-start gap-4">
                  <div class={cn(
                    'flex-shrink-0 w-10 h-10 rounded-xl',
                    'bg-gradient-to-br from-[var(--color-primary)] to-[var(--color-primary-dark)]',
                    'flex items-center justify-center',
                    'text-white font-bold text-sm',
                    'shadow-lg shadow-[var(--color-primary)]/20',
                    'group-hover:scale-110 transition-transform duration-300'
                  )}>
                    {index + 1}
                  </div>
                  <p class="flex-1 text-[var(--color-text-body)] leading-relaxed pt-2">
                    {highlight}
                  </p>
                </div>
              </div>
            ))}
          </div>

          <!-- Stats Summary -->
          {(data.highlights.length >= 3 || data.tags?.length >= 4) && (
            <div class={cn(
              'grid grid-cols-3 gap-6 mt-10 pt-10',
              'border-t border-[var(--color-border-glass)]'
            )}>
              <div class="text-center">
                <div class="text-3xl font-bold text-[var(--color-text-heading)] mb-1">
                  {data.highlights.length}
                </div>
                <div class="text-xs uppercase tracking-wider text-[var(--color-text-muted)]">
                  Достижений
                </div>
              </div>
              <div class="text-center">
                <div class="text-3xl font-bold text-[var(--color-primary)] mb-1">
                  {data.tags?.length || 0}
                </div>
                <div class="text-xs uppercase tracking-wider text-[var(--color-text-muted)]">
                  Технологий
                </div>
              </div>
              <div class="text-center">
                <div class="text-3xl font-bold text-brand-500 mb-1">
                  ✓
                </div>
                <div class="text-xs uppercase tracking-wider text-[var(--color-text-muted)]">
                  Завершён
                </div>
              </div>
            </div>
          )}
        </div>
      </Container>
    </section>
  )}

  <!-- Bottom Navigation -->
  <section class="py-10 border-t border-[var(--color-border-glass)]">
    <Container>
      <div class="flex flex-col sm:flex-row items-center justify-between gap-4">
        <Button
          href="/projects"
          variant="ghost"
          size="md"
        >
          <Icon name="arrow-left" size="sm" />
          Все проекты
        </Button>
        
        <div class="flex items-center gap-3">
          {data.github && (
            <Button
              href={data.github}
              variant="ghost"
              size="md"
              external
            >
              <Icon name="github" size="sm" />
              <span class="hidden sm:inline">Код</span>
            </Button>
          )}
          {data.demo && (
            <Button
              href={data.demo}
              variant="primary"
              size="md"
              external
            >
              Открыть
              <Icon name="arrow-up-right" size="sm" />
            </Button>
          )}
        </div>
      </div>
    </Container>
  </section>
</article>
